# docker-compose.yml  (Portainer Stack용)
# Compose Spec 권장: version 라인은 생략 가능. depends_on은 "리스트"만 사용.
services:
  reverse-proxy:
    image: nginx:alpine
    container_name: reverse_proxy
    ports:
      - "80:80"
    volumes:
      - ./reverse-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:            # ✅ 리스트 표기만 사용
      - frontend
      - backend
    networks:
      - app_net

  frontend:
    # Portainer Git 배포에서 build context는 리포지토리 상대경로여야 함
    build: ./frontend      # ✅ 절대경로 금지
    # image: your-frontend:latest  # 빌드 대신 이미지 쓰면 주석 해제
    container_name: app_frontend
    depends_on:            # ✅ 리스트
      - backend
    networks:
      - app_net

  backend:
    # build 또는 image 중 하나만 사용
    build: ./backend       # ✅ 리포지토리 내부 경로
    # image: your-backend:latest
    container_name: app_backend
    env_file: ./.env
    ports:
      - "8080:8080"
    depends_on:            # ✅ 리스트
      - db
    networks:
      - app_net

  db:
    image: postgres:16-alpine
    container_name: app_db
    environment:
      POSTGRES_DB: packetdb
      POSTGRES_USER: packet
      POSTGRES_PASSWORD: packetpass
    volumes:
      - db_data:/var/lib/postgresql/data
    # 필요 시 healthcheck 추가 가능(Portainer 일부 옵션 미지원 주의)
    # healthcheck:
    #   test: ["CMD-SHELL", "pg_isready -U packet -d packetdb"]
    #   interval: 5s
    #   timeout: 3s
    #   retries: 30
    networks:
      - app_net

networks:
  app_net: {}

volumes:
  db_data: {}
